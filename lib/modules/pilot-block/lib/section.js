


define(["require", "modules/pilot-block/lib/utils"], function(require) {

    var __dirname = "modules/pilot-block/lib",
    __filename    = "modules/pilot-block/lib/section.js",
    module        = { exports: {} },
    exports       = module.exports,
    define        = undefined,
    window        = exports,
    global        = window;

    

    // Generated by CoffeeScript 1.6.2
var Section, utils;

utils = require("modules/pilot-block/lib/utils");

Section = (function() {
  Section.prototype.__isSection = true;

  /*
  */


  function Section(name, start, pilot) {
    this.name = name;
    this.start = start;
    this.pilot = pilot;
    if (!start.parentNode || (start != null ? start.parentNode.nodeType : void 0) === 11) {
      utils.copySiblings(this.start, document.createElement("div"));
    }
    this.update();
  }

  /*
  */


  Section.prototype.removeElements = function() {
    this.detach();
    this.elements = [];
    return this.allElements = [];
  };

  /*
  */


  Section.prototype.reset = function(start) {
    if (this.start === start) {
      return;
    }
    this.start = start;
    return this.update();
  };

  /*
  */


  Section.prototype.removeAll = function() {
    var _ref, _ref1;

    this.pilot._removeSection(this);
    this.removeElements();
    if ((_ref = this.start.parentNode) != null) {
      _ref.removeChild(this.start);
    }
    return (_ref1 = this.end.parentNode) != null ? _ref1.removeChild(this.end) : void 0;
  };

  /*
  */


  Section.prototype.appendTo = function(element) {
    return utils.moveChildren(utils.arrayToFragment(this.allElements), element);
  };

  /*
  */


  Section.prototype.append = function() {
    utils.insertAfter(this._parseElements(arguments), this.end.previousSibling);
    this.unguard();
    return this.update();
  };

  /*
  */


  Section.prototype.prepend = function() {
    utils.insertAfter(this._parseElements(arguments), this.start);
    this.unguard();
    return this.update();
  };

  /*
  */


  Section.prototype.unguard = function() {
    return utils.unguardComments(this.start.parentNode);
  };

  /*
  */


  Section.prototype.replaceChildren = function(element) {
    utils.removeAllChildren(element);
    return this.appendTo(element);
  };

  /*
   Sets the HTML content before each comment blocks
  */


  Section.prototype.html = function(content) {
    if (!arguments.length) {
      return this.toString();
    }
    this.update();
    this.removeElements();
    return this.prepend(utils.createElements(content));
  };

  /*
  */


  Section.prototype.toString = function() {
    return utils.guardComments($(this.start.parentNode).html());
  };

  /*
  */


  Section.prototype.updateChildren = function() {
    return this.pilot.update(this.start.parentNode);
  };

  /*
  */


  Section.prototype.controller = function(value) {
    if (!arguments.length) {
      return this._controller;
    }
    return this._controller = value;
  };

  /*
  */


  Section.prototype.dispose = function() {
    return this.removeAll();
  };

  /*
  */


  Section.prototype.update = function() {
    var celement, elements, endElement, nid;

    celement = this.start.nextSibling;
    nid = "epc:" + this.name;
    elements = [];
    while (celement) {
      if (celement.nodeName === "#comment" && String(celement.nodeValue) === nid) {
        endElement = celement;
        break;
      }
      elements.push(celement);
      celement = celement.nextSibling;
    }
    this.elements = elements;
    this.end = endElement;
    return this.allElements = [this.start].concat(elements).concat([this.end]);
  };

  /*
   TRUE if attached to the dom
  */


  Section.prototype.attachedToDOM = function() {
    var p;

    p = this.start;
    while (p && (p !== document.body)) {
      p = p.parentNode;
    }
    return p === document.body;
  };

  /*
   detaches the elements within the comment blocks
  */


  Section.prototype.detach = function() {
    var celement, celements, parent;

    this._detached = true;
    celements = [];
    celement = this.start.nextSibling;
    parent = this.start.parentNode;
    if (!parent) {
      return;
    }
    while (celement && celement !== this.end) {
      celements.push(celement);
      parent.removeChild(celement);
      celement = this.start.nextSibling;
    }
    this.detachedElements = celements;
    return this.update();
  };

  /*
  */


  Section.prototype.dispose = function() {
    return this.removeAll();
  };

  /*
   re-adds the elements within the comment blocks
  */


  Section.prototype.attach = function() {
    var element, frag, _i, _len, _ref;

    if (!this._detached) {
      return;
    }
    frag = document.createDocumentFragment();
    _ref = this.detachedElements;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      element = _ref[_i];
      frag.appendChild(element);
    }
    this.start.parentNode.insertBefore(frag, this.end);
    return this.update();
  };

  /*
  */


  Section.prototype._parseElement = function(element) {
    if (typeof element === "string") {
      return utils.createElements(element).childNodes;
    } else if (element.__isSection) {
      return utils.arrayToFragment(element.allElements);
    } else {
      return element;
    }
  };

  /*
  */


  Section.prototype._parseElements = function(elements) {
    var el, frag, _i, _len;

    frag = document.createDocumentFragment();
    for (_i = 0, _len = elements.length; _i < _len; _i++) {
      el = elements[_i];
      frag.appendChild(this._parseElement(el));
    }
    return frag;
  };

  return Section;

})();

module.exports = Section;


    return module.exports;
});