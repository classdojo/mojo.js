// Generated by CoffeeScript 1.6.2
/*

Notes:

1. cstep is used so that teardown & other functions wait until the previous method is calld. For instance - 
if setup is called, then teardown immediately, then teardown MUST wait until setup is complete
*/


(function() {
  define(["underscore", "cstep", "../../utils/async", "../../factories/class", "../../utils/idGenerator", "./base", "../collection", "../../utils/compose", "./template", "./children", "./list/decorator", "./attributes", "./events", "./bindings", "./dragdrop/draggable", "./dragdrop/droppable", "./states/decorator", "./transition", "./preload"], function(_, cstep, async, ClassFactory, generateId, BaseViewDecorator, ViewCollection, compose, TemplateDecorator, ChildrenDecorator, ListDecorator, AttributesDecorator, EventsDecorator, BindingsDecorator, DraggableDecorator, DroppableDecorator, StatesDecorator, TransitionDecorator, PreloadDecorator) {
    var availableDecorators, decor;

    decor = function(name, clazz, inheritable) {
      if (inheritable == null) {
        inheritable = true;
      }
      return {
        name: name,
        clazz: clazz,
        inheritable: inheritable
      };
    };
    /*
    loading order:
    
    1. children templates
    2. parent templates
    3. parent -> child bindings
    */

    availableDecorators = [decor("bindings", BindingsDecorator), decor("list", ListDecorator), decor("states", StatesDecorator), decor("children", ChildrenDecorator), decor("template", TemplateDecorator, false), decor("preload", PreloadDecorator), decor("attributes", AttributesDecorator), decor("transition", TransitionDecorator), decor("events", EventsDecorator), decor("draggable", DraggableDecorator), decor("droppable", DroppableDecorator)];
    return {
      /*
      */

      addDecoratorClass: function(options) {
        if (options == null) {
          options = {};
        }
        return availableDecorators.push(decor(options.name, options["class"] || options.clazz, options.inheritable));
      },
      /*
      */

      setup: function(view) {
        if (view.constructor.__decorators) {
          return this.setDecorators(view, view.constructor.__decorators);
        } else {
          view.constructor.__decorators = this.findDecorators(view.constructor);
          return this.setup(view);
        }
      },
      /*
       Finds ALL the decorators for a view, including the parent 
       decorators which should be inherited (but overridden by the child prototype)
      */

      findDecorators: function(viewClass) {
        var cv, decorators, pv, _ref;

        decorators = [];
        cv = viewClass;
        pv = void 0;
        while (cv && cv.prototype.__isView) {
          decorators = decorators.concat(this._findDecorators(cv, pv).concat(this._findDecorators(cv.prototype, pv != null ? pv.prototype : void 0)));
          pv = cv;
          cv = (_ref = cv.__super__) != null ? _ref.constructor : void 0;
        }
        return decorators.sort(function(a, b) {
          if (a.priority > b.priority) {
            return 1;
          } else {
            return -1;
          }
        });
      },
      /*
      */

      _findDecorators: function(proto, child) {
        var clazz, d, decorators, options, priority, _i, _len;

        decorators = [];
        for (priority = _i = 0, _len = availableDecorators.length; _i < _len; priority = ++_i) {
          d = availableDecorators[priority];
          clazz = d.clazz;
          if (child && !d.inheritable) {
            continue;
          }
          if (options = clazz.getOptions(proto)) {
            if (child && options === clazz.getOptions(child)) {
              continue;
            }
            decorators.push({
              clazz: clazz,
              name: d.name,
              options: options,
              priority: priority
            });
          }
        }
        return decorators;
      },
      /*
      */

      setDecorators: function(view, decorators) {
        var d, _i, _len, _results;

        _results = [];
        for (_i = 0, _len = decorators.length; _i < _len; _i++) {
          decor = decorators[_i];
          d = new decor.clazz(view, decor.options);
          d._id = decor.name;
          _results.push(view.decorators.push(d));
        }
        return _results;
      }
    };
  });

}).call(this);
