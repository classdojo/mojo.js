// Generated by CoffeeScript 1.6.2
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(["jquery", "../bindable/inheritable", "./collection", "../utils/idGenerator", "dref", "../models/locator", "pilot-block", "./states", "type-component"], function($, BindableInheritableObject, ViewCollection, generateId, dref, modelLocator, pilot, ViewStates, type) {
    var InternalView;

    return InternalView = (function(_super) {
      __extends(InternalView, _super);

      /*
      */


      InternalView.prototype.__isView = true;

      /*
      */


      function InternalView(data) {
        if (data == null) {
          data = {};
        }
        this._onRemoved = __bind(this._onRemoved, this);
        this._onRemove = __bind(this._onRemove, this);
        this._onDisplayed = __bind(this._onDisplayed, this);
        this._onDisplay = __bind(this._onDisplay, this);
        this._onRendered = __bind(this._onRendered, this);
        this._onRender = __bind(this._onRender, this);
        this._onLoaded = __bind(this._onLoaded, this);
        this._onLoad = __bind(this._onLoad, this);
        this.dispose = __bind(this.dispose, this);
        this._id = dref.get(data.model || {}, "_id") || generateId();
        data.currentState = ViewStates.NONE;
        InternalView.__super__.constructor.call(this, data);
        this.init();
      }

      /*
      */


      InternalView.prototype.init = function() {
        this._copyThisToData();
        this.decorators = this.loadables = new ViewCollection();
        this.decorators.view = this;
        this.section = pilot.createSection();
        this._initListeners();
        this._initDecor();
        return this._initBindings();
      };

      /*
      */


      InternalView.prototype._copyThisToData = function() {
        var key, v, _results;

        _results = [];
        for (key in this.constructor.prototype) {
          v = this.constructor.prototype[key];
          if (key.substr(0, 1) === "_") {
            continue;
          }
          _results.push(this.set(key, v));
        }
        return _results;
      };

      /*
      */


      InternalView.prototype.load = function(next) {
        return this.decorators.load(next);
      };

      InternalView.prototype.render = function(next) {
        return this.decorators.render(next);
      };

      InternalView.prototype.display = function(next) {
        return this.decorators.display(next);
      };

      InternalView.prototype.remove = function(next) {
        return this.decorators.remove(next);
      };

      /*
       returns a search for a particular element
       TODO - this shouldn't really exist - leave it up
       to any decorator to implement this, or place it in 
       a utility function
      */


      InternalView.prototype.$ = function(search) {
        var el;

        el = $(this.section.elements);
        if (arguments.length) {
          return el.find(search);
        }
        return el;
      };

      /*
       attaches to an element to the DOM
      */


      InternalView.prototype.attach = function(element, callback) {
        var _this = this;

        this._domElement = element[0] || element;
        this.decorators.once("display", function() {
          return _this.section.replaceChildren(_this._domElement);
        });
        return this.display(callback);
      };

      /*
      */


      InternalView.prototype.dispose = function() {
        var el;

        el = this.$();
        el.unbind("*");
        this.section.dispose();
        return InternalView.__super__.dispose.call(this);
      };

      /*
      */


      InternalView.prototype._initListeners = function() {
        return this.decorators.on({
          load: this._onLoad,
          loaded: this._onLoaded,
          render: this._onRender,
          rendered: this._onRendered,
          display: this._onDisplay,
          displayed: this._onDisplayed,
          remove: this._onRemove,
          removed: this._onRemoved
        });
      };

      /*
      */


      InternalView.prototype._initDecor = function() {};

      /*
      */


      InternalView.prototype._initBindings = function() {
        return this.decorators.bind("currentState").to(this, "currentState").now();
      };

      /*
      */


      InternalView.prototype._onLoad = function() {};

      InternalView.prototype._onLoaded = function() {
        var _ref;

        if (((_ref = this._parent) != null ? _ref.get("currentState") : void 0) === ViewStates.LOADING) {
          return;
        }
        return this.section.updateChildren();
      };

      /*
      */


      InternalView.prototype._onRender = function() {};

      InternalView.prototype._onRendered = function() {};

      /*
      */


      InternalView.prototype._onDisplay = function() {};

      InternalView.prototype._onDisplayed = function() {};

      /*
      */


      InternalView.prototype._onRemove = function() {};

      InternalView.prototype._onRemoved = function() {
        var _ref;

        if (((_ref = this._parent) != null ? _ref.get("currentState") : void 0) === ViewStates.REMOVING) {
          return;
        }
        return this.dispose();
      };

      return InternalView;

    })(BindableInheritableObject);
  });

}).call(this);
